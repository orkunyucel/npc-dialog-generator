<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NPC Dialog Generator - AI-Powered Game Development Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background-animation"></div>
    
    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal show">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTutorial()">√ó</button>
            <h2>üéÆ Welcome to NPC Dialog Generator!</h2>
            
            <div class="tutorial-section">
                <h3>üìñ What is it?</h3>
                <p>This tool generates AI-powered NPC (Non-Player Character) dialogues for game developers. Like the townspeople in Witcher 3, each NPC will have unique and characteristic lines.</p>
            </div>
            
            <div class="tutorial-section">
                <h3>üéØ How to Use?</h3>
                <ol>
                    <li><strong>Scene Description:</strong> Describe your game scene in detail</li>
                    <li><strong>NPC Character:</strong> Specify who is speaking (e.g., "her mother", "the merchant", "village elder")</li>
                    <li><strong>Choose Style:</strong> Select the dialog style that fits your game</li>
                    <li><strong>Generate Dialogues:</strong> AI will create 10 different NPC dialogues</li>
                    <li><strong>Export & Use:</strong> Export in your preferred format for your game engine</li>
                </ol>
            </div>
            
            <div class="tutorial-section">
                <h3>üí° Tips</h3>
                <ul>
                    <li>Detailed descriptions give better results</li>
                    <li>Be specific about NPC relationships (e.g., "the girl's worried mother" not just "woman")</li>
                    <li>Specify emotions (scared, happy, angry, etc.)</li>
                    <li>Try different styles for variety</li>
                    <li>Save your favorite dialogues</li>
                    <li>NEW: Convert any dialogue to an interactive conversation!</li>
                </ul>
            </div>
            
            <button class="tutorial-start-btn" onclick="closeTutorial()">Start Creating!</button>
        </div>
    </div>
    
    <!-- Saved Scenes Sidebar -->
    <div id="savedScenes" class="saved-scenes">
        <h3>üìö Saved Scenes</h3>
        <div id="savedScenesList"></div>
    </div>
    
    <button id="helpBtn" class="help-button" onclick="showTutorial()">?</button>
    <button id="savedBtn" class="saved-button" onclick="toggleSavedScenes()">üìö</button>
    
    <main class="main-container">
        <div class="app-container">
            <header class="app-header">
                <div class="logo">
                    <span class="logo-icon">üéÆ</span>
                    <h1>NPC Dialog Generator</h1>
                </div>
                <p class="subtitle">AI-powered dialogue generator for Game Development</p>
            </header>

            <section class="input-section">
                <button class="templates-btn" onclick="showTemplates()">
                    üìã Use Scene Template
                </button>
                
                <form id="promptForm">
                    <div class="form-group">
                        <label for="promptInput">Scene Description</label>
                        <div class="textarea-wrapper">
                            <textarea 
                                id="promptInput" 
                                placeholder="Example: A dragon is attacking the village, people are panicking...&#10;Example 2: A fisherman trying to sell his fresh catch..."
                                required
                                rows="4"
                            ></textarea>
                            <div class="char-count">
                                <span id="charCount">0</span>/500
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group npc-character-group">
                        <label for="npcCharacterInput">NPC Character (Who is speaking?)</label>
                        <div class="textarea-wrapper">
                            <textarea 
                                id="npcCharacterInput" 
                                class="npc-character-textarea"
                                placeholder="Examples: the girl's mother, village guard, injured soldier, merchant, little boy..."
                                rows="2"
                            ></textarea>
                            <div class="char-count">
                                <span id="npcCharCount">0</span>/100
                            </div>
                        </div>
                        <div class="npc-examples">
                            üí° Tip: Be specific! Instead of <span>"woman"</span>, try <span>"the girl's worried mother"</span> or <span>"elderly shopkeeper"</span>
                        </div>
                    </div>
                    
                    <div class="style-options">
                        <label>Dialog Style</label>
                        <div class="style-grid">
                            <button type="button" class="style-btn active" data-style="mixed">
                                üé≠ Mixed
                            </button>
                            <button type="button" class="style-btn" data-style="medieval">
                                ‚öîÔ∏è Medieval
                            </button>
                            <button type="button" class="style-btn" data-style="modern">
                                üèôÔ∏è Modern
                            </button>
                            <button type="button" class="style-btn" data-style="scifi">
                                üöÄ Sci-Fi
                            </button>
                            <button type="button" class="style-btn" data-style="horror">
                                üëª Horror
                            </button>
                            <button type="button" class="style-btn" data-style="comedy">
                                üòÑ Comedy
                            </button>
                        </div>
                    </div>

                    <div class="emotion-options">
                        <label>Primary Emotion</label>
                        <select id="emotionSelect" class="emotion-select">
                            <option value="">Auto-detect from scene</option>
                            <option value="fearful">üò® Fearful</option>
                            <option value="angry">üò† Angry</option>
                            <option value="happy">üòä Happy</option>
                            <option value="sad">üò¢ Sad</option>
                            <option value="surprised">üò≤ Surprised</option>
                            <option value="neutral">üòê Neutral</option>
                        </select>
                    </div>

                    <div class="advanced-options">
                        <details>
                            <summary>‚öôÔ∏è Advanced Options</summary>
                            <div class="advanced-content">
                                <label>
                                    <input type="checkbox" id="includeActions" checked> 
                                    Include actions (*walks away*, *sighs*, etc.)
                                </label>
                                <label>
                                    <input type="checkbox" id="includeNames" checked> 
                                    Include NPC addressing (Stranger, Friend, etc.)
                                </label>
                                <label>
                                    Dialog Length:
                                    <input type="range" id="lengthRange" min="1" max="3" value="2">
                                    <span id="lengthLabel">Medium</span>
                                </label>
                            </div>
                        </details>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" id="generateBtn" class="generate-btn">
                            <span class="btn-text">Generate NPC Dialogues</span>
                            <span class="btn-icon">‚ú®</span>
                        </button>
                        
                        <button type="button" id="generateImageBtn" class="generate-image-btn">
                            <span class="btn-text">Create Scene Image</span>
                            <span class="btn-icon">üé®</span>
                        </button>
                    </div>
                </form>
            </section>

            <section id="imageSection" class="image-section" style="display: none;">
                <div class="image-container">
                    <h3>Generated Scene Visual</h3>
                    <div id="imageLoading" class="loading-container" style="display:none;">
                        <div class="loading-spinner"></div>
                        <p>Creating image...</p>
                    </div>
                    <img id="generatedImage" class="generated-image" style="display:none;" />
                </div>
            </section>

            <section id="resultsSection" class="results-section" style="display: none;">
                <div class="results-header">
                    <h2>Generated NPC Dialogues</h2>
                    <div class="header-buttons">
                        <button id="copyAllBtn" class="copy-all-btn">
                            üìã Copy All
                        </button>
                        <button id="saveSceneBtn" class="save-scene-btn" onclick="saveScene()">
                            üíæ Save Scene
                        </button>
                        <div class="export-buttons">
                            <button onclick="exportAsJSON()" class="export-btn" title="Export as JSON">
                                <span>üìÑ JSON</span>
                            </button>
                            <button onclick="exportAsCSV()" class="export-btn" title="Export as CSV">
                                <span>üìä CSV</span>
                            </button>
                            <button onclick="exportForUnity()" class="export-btn" title="Export for Unity">
                                <span>üéÆ Unity</span>
                            </button>
                            <button onclick="exportForUnreal()" class="export-btn" title="Export for Unreal">
                                <span>üéØ Unreal</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="loading" class="loading-container" style="display:none;">
                    <div class="loading-spinner"></div>
                    <p>AI is generating dialogues...</p>
                </div>
                
                <div id="responses" class="responses-grid"></div>
            </section>
        </div>
    </main>

    <div class="toast" id="toast"></div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTemplates()">√ó</button>
            <h2>üìã Scene Templates</h2>
            <div id="templatesList" class="templates-list"></div>
        </div>
    </div>

    <!-- Dialog Modal -->
    <div id="dialogModal" class="dialog-modal">
        <div class="dialog-container">
            <div class="dialog-header-bar">
                <h2 class="dialog-title">
                    <span>üí¨</span>
                    Interactive Dialog Mode
                </h2>
                <button class="dialog-close-btn" onclick="closeDialogMode()">√ó</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="dialog-tabs">
                <button class="dialog-tab active" onclick="switchDialogTab('conversation')">
                    üí¨ Conversation
                </button>
                <button class="dialog-tab" onclick="switchDialogTab('images')">
                    üé® Generated Images
                    <span class="tab-badge" id="imageCountBadge" style="display: none;">0</span>
                </button>
            </div>
            
            <!-- Tab Contents -->
            <div class="dialog-tab-contents">
                <!-- Conversation Tab -->
                <div id="conversationTab" class="dialog-tab-content active">
                    <div class="dialog-content">
                        <div class="dialog-history" id="dialogHistory">
                            <!-- Dialog messages will appear here -->
                        </div>
                        
                        <div class="dialog-input-area">
                            <!-- Image generation button -->
                            <div class="dialog-image-section">
                                <button type="button" class="dialog-generate-image-btn" onclick="generateDialogImage()">
                                    <span class="btn-text">Create Scene Image</span>
                                    <span class="btn-icon">üé®</span>
                                </button>
                            </div>
                            
                            <form id="dialogForm" class="dialog-form">
                                <!-- Scene update area -->
                                <div class="dialog-scene-update">
                                    <label for="dialogSceneUpdate">
                                        <span>üé¨ Scene Update (Optional)</span>
                                        <button type="button" class="scene-toggle-btn" onclick="toggleSceneUpdate()">
                                            <span class="toggle-icon">‚ûï</span>
                                        </button>
                                    </label>
                                    <textarea 
                                        id="dialogSceneUpdate" 
                                        class="dialog-scene-textarea"
                                        placeholder="e.g., The dragon left the girl and turned towards the merchant on the road..."
                                        rows="3"
                                        style="display: none;"
                                    ></textarea>
                                </div>
                                
                                <div class="dialog-inputs-row">
                                    <div class="dialog-input-group">
                                        <label for="dialogNpcInput">Next Speaker (NPC Character)</label>
                                        <input 
                                            type="text" 
                                            id="dialogNpcInput" 
                                            class="dialog-npc-input"
                                            placeholder="e.g., village guard, merchant, the girl's father..."
                                            required
                                        >
                                    </div>
                                    
                                    <div class="dialog-input-group">
                                        <label for="dialogEmotionSelect">Emotion</label>
                                        <select id="dialogEmotionSelect" class="dialog-emotion-select">
                                            <option value="">Auto</option>
                                            <option value="fearful">üò® Fearful</option>
                                            <option value="angry">üò† Angry</option>
                                            <option value="happy">üòä Happy</option>
                                            <option value="sad">üò¢ Sad</option>
                                            <option value="surprised">üò≤ Surprised</option>
                                            <option value="neutral">üòê Neutral</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button type="submit" class="dialog-generate-btn">
                                    <span>Generate Response</span>
                                    <span>üé≠</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Images Tab -->
                <div id="imagesTab" class="dialog-tab-content">
                    <div class="dialog-images-container">
                        <div id="dialogImagesList" class="dialog-images-list">
                            <!-- Generated images will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dialog-actions">
                <button onclick="exportDialog('text')" class="dialog-export-btn">
                    üìù Export as Text
                </button>
                <button onclick="exportDialog('json')" class="dialog-export-btn">
                    üìÑ Export as JSON
                </button>
                <button onclick="exportDialogImages()" class="dialog-export-btn" id="exportImagesBtn" style="display: none;">
                    üé® Export Images Data
                </button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('promptForm');
        const promptInput = document.getElementById('promptInput');
        const npcCharacterInput = document.getElementById('npcCharacterInput');
        const responsesDiv = document.getElementById('responses');
        const loadingDiv = document.getElementById('loading');
        const generateBtn = document.getElementById('generateBtn');
        const generateImageBtn = document.getElementById('generateImageBtn');
        const resultsSection = document.getElementById('resultsSection');
        const imageSection = document.getElementById('imageSection');
        const charCount = document.getElementById('charCount');
        const npcCharCount = document.getElementById('npcCharCount');
        const copyAllBtn = document.getElementById('copyAllBtn');
        const toast = document.getElementById('toast');
        const tutorialModal = document.getElementById('tutorialModal');
        const lengthRange = document.getElementById('lengthRange');
        const lengthLabel = document.getElementById('lengthLabel');
        
        // Dialog mode variables
        let currentDialogId = null;
        let dialogHistory = [];
        let currentScene = '';
        let dialogImages = [];
        
        // Length range labels
        const lengthLabels = ['Short', 'Medium', 'Long'];
        lengthRange.addEventListener('input', () => {
            lengthLabel.textContent = lengthLabels[lengthRange.value - 1];
        });
        
        // Style buttons
        let selectedStyle = 'mixed';
        document.querySelectorAll('.style-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedStyle = btn.dataset.style;
            });
        });
        
        // Tutorial functions
        function closeTutorial() {
            tutorialModal.classList.remove('show');
            localStorage.setItem('tutorialSeen', 'true');
        }
        
        function showTutorial() {
            tutorialModal.classList.add('show');
        }
        
        // Check if tutorial was seen before
        if (localStorage.getItem('tutorialSeen') === 'true') {
            tutorialModal.classList.remove('show');
        }

        // Character counter for main prompt
        promptInput.addEventListener('input', () => {
            const length = promptInput.value.length;
            charCount.textContent = length;
            if (length > 500) {
                promptInput.value = promptInput.value.substring(0, 500);
                charCount.textContent = 500;
            }
        });

        // Character counter for NPC input
        npcCharacterInput.addEventListener('input', () => {
            const length = npcCharacterInput.value.length;
            npcCharCount.textContent = length;
            if (length > 100) {
                npcCharacterInput.value = npcCharacterInput.value.substring(0, 100);
                npcCharCount.textContent = 100;
            }
        });

        // Copy all functionality
        copyAllBtn.addEventListener('click', async () => {
            const allDialogs = Array.from(document.querySelectorAll('.dialog-text'))
                .map(el => el.textContent)
                .join('\n\n');
            
            try {
                await navigator.clipboard.writeText(allDialogs);
                showToast('All dialogues copied!');
            } catch (err) {
                showToast('Copy failed!', 'error');
            }
        });

        // Toast notification
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Copy individual dialog
        async function copyDialog(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = button.innerHTML;
                button.innerHTML = '‚úì';
                button.classList.add('copied');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                showToast('Copy failed!', 'error');
            }
        }

        // Generate Image
        generateImageBtn.onclick = async () => {
            if (!promptInput.value.trim()) {
                showToast('Please enter a scene description!', 'error');
                return;
            }

            imageSection.style.display = 'block';
            document.getElementById('generatedImage').style.display = 'none';
            document.getElementById('imageLoading').style.display = 'flex';
            generateImageBtn.disabled = true;

            try {
                const res = await fetch('/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptInput.value })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const img = document.getElementById('generatedImage');
                
                img.onload = function() {
                    img.style.display = 'block';
                    document.getElementById('imageLoading').style.display = 'none';
                    showToast('Image created!');
                };
                
                img.onerror = function() {
                    document.getElementById('imageLoading').style.display = 'none';
                    showToast('Image could not be loaded!', 'error');
                    console.error('Image URL:', data.image_url);
                };
                
                img.src = data.image_url;
                
            } catch (err) {
                document.getElementById('imageLoading').style.display = 'none';
                showToast('Image creation failed!', 'error');
                console.error('Error:', err);
            }
            
            generateImageBtn.disabled = false;
        };

        // Form submission
        form.onsubmit = async (e) => {
            e.preventDefault();
            
            if (!promptInput.value.trim()) {
                showToast('Please enter a scene description!', 'error');
                return;
            }

            resultsSection.style.display = 'block';
            responsesDiv.innerHTML = "";
            loadingDiv.style.display = "flex";
            generateBtn.disabled = true;
            generateBtn.classList.add('loading');

            try {
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: promptInput.value,
                        npcCharacter: npcCharacterInput.value.trim(),
                        style: selectedStyle,
                        emotion: document.getElementById('emotionSelect').value,
                        includeActions: document.getElementById('includeActions').checked,
                        includeNames: document.getElementById('includeNames').checked,
                        length: lengthLabels[lengthRange.value - 1].toLowerCase()
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.dialogs && data.dialogs.length > 0) {
                    window.generatedDialogs = data.dialogs;
                    window.currentNpcCharacter = data.npcCharacter || '';
                    const npcTag = data.npcCharacter ? 
                        `<span class="npc-character-tag">${data.npcCharacter}</span>` : '';
                    
                    responsesDiv.innerHTML = data.dialogs.map((dialog, i) => `
                        <div class="dialog-card" style="animation-delay: ${i * 0.1}s">
                            <button class="favorite-btn" onclick="toggleFavorite('${dialog.replace(/'/g, "\\'")}', this)">
                                ‚òÜ
                            </button>
                            <div class="dialog-header">
                                <div class="npc-info">
                                    <span class="npc-name">Dialogue ${i + 1}</span>
                                    ${npcTag}
                                </div>
                                <button class="copy-btn" onclick="copyDialog('${dialog.replace(/'/g, "\\'")}', this)">
                                    üìã
                                </button>
                            </div>
                            <p class="dialog-text">${dialog}</p>
                            <div class="dialog-footer">
                                <button class="convert-dialog-btn" data-dialog-index="${i}">
                                    <span class="icon">üí¨</span>
                                    <span>Convert to Dialog</span>
                                </button>
                                <button class="regenerate-btn" onclick="regenerateDialog(${i})">
                                    <span class="regenerate-icon">üîÑ</span>
                                    <span class="regenerate-text">Regenerate</span>
                                </button>
                            </div>
                        </div>
                    `).join("");
                    showToast('Dialogues generated successfully!');
                } else {
                    throw new Error('Could not generate dialogues');
                }
            } catch (err) {
                responsesDiv.innerHTML = `
                    <div class="error-card">
                        <span class="error-icon">‚ö†Ô∏è</span>
                        <p>An error occurred: ${err.message}</p>
                        <button onclick="location.reload()" class="retry-btn">Try Again</button>
                    </div>
                `;
                showToast('Error occurred!', 'error');
            }
            
            loadingDiv.style.display = "none";
            generateBtn.disabled = false;
            generateBtn.classList.remove('loading');
        };

        // Export Functions
        function exportAsJSON() {
            const dialogs = Array.from(document.querySelectorAll('.dialog-text'))
                .map((el, index) => ({
                    id: index + 1,
                    text: el.textContent,
                    scene: promptInput.value,
                    npcCharacter: npcCharacterInput.value.trim(),
                    style: selectedStyle,
                    timestamp: new Date().toISOString()
                }));
            
            const dataStr = JSON.stringify({
                scene_description: promptInput.value,
                npc_character: npcCharacterInput.value.trim(),
                generated_at: new Date().toISOString(),
                style: selectedStyle,
                dialogs: dialogs
            }, null, 2);
            
            downloadFile(dataStr, 'npc-dialogs.json', 'application/json');
            showToast('Exported as JSON!');
        }

        function exportAsCSV() {
            const dialogs = Array.from(document.querySelectorAll('.dialog-text'));
            let csv = 'ID,Dialog,Scene,NPC Character,Style,Generated At\n';
            
            dialogs.forEach((el, index) => {
                const text = el.textContent.replace(/"/g, '""');
                const npc = npcCharacterInput.value.trim().replace(/"/g, '""');
                csv += `${index + 1},"${text}","${promptInput.value}","${npc}","${selectedStyle}","${new Date().toLocaleString()}"\n`;
            });
            
            downloadFile(csv, 'npc-dialogs.csv', 'text/csv');
            showToast('Exported as CSV!');
        }

        function exportForUnity() {
            const dialogs = Array.from(document.querySelectorAll('.dialog-text'));
            let unityFormat = `// NPC Dialogs for Unity\n// Scene: ${promptInput.value}\n// NPC: ${npcCharacterInput.value.trim() || 'Various'}\n// Style: ${selectedStyle}\n// Generated: ${new Date().toLocaleString()}\n\n`;
            
            unityFormat += 'using System.Collections.Generic;\n\n';
            unityFormat += 'public static class NPCDialogs {\n';
            unityFormat += `    public static string npcCharacter = "${npcCharacterInput.value.trim()}";\n`;
            unityFormat += '    public static List<string> dialogs = new List<string>() {\n';
            
            dialogs.forEach((el, index) => {
                const text = el.textContent.replace(/"/g, '\\"');
                unityFormat += `        "${text}"${index < dialogs.length - 1 ? ',' : ''}\n`;
            });
            
            unityFormat += '    };\n}';
            
            downloadFile(unityFormat, 'NPCDialogs.cs', 'text/plain');
            showToast('Exported for Unity!');
        }

        function exportForUnreal() {
            const dialogs = Array.from(document.querySelectorAll('.dialog-text'));
            let unrealFormat = `// NPC Dialogs for Unreal Engine\n// Scene: ${promptInput.value}\n// NPC: ${npcCharacterInput.value.trim() || 'Various'}\n// Style: ${selectedStyle}\n\n`;
            
            unrealFormat += '#pragma once\n\n';
            unrealFormat += '#include "CoreMinimal.h"\n\n';
            unrealFormat += `static const FString NPCCharacter = TEXT("${npcCharacterInput.value.trim()}");\n\n`;
            
            dialogs.forEach((el, index) => {
                const text = el.textContent.replace(/"/g, '\\"');
                unrealFormat += `static const FText Dialog${index + 1} = FText::FromString(TEXT("${text}"));\n`;
            });
            
            downloadFile(unrealFormat, 'NPCDialogs.h', 'text/plain');
            showToast('Exported for Unreal!');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Scene update toggle function
        function toggleSceneUpdate() {
            const textarea = document.getElementById('dialogSceneUpdate');
            const toggleBtn = document.querySelector('.scene-toggle-btn .toggle-icon');
            
            if (textarea.style.display === 'none') {
                textarea.style.display = 'block';
                toggleBtn.textContent = '‚ûñ';
                textarea.focus();
            } else {
                textarea.style.display = 'none';
                toggleBtn.textContent = '‚ûï';
                textarea.value = '';
            }
        }

        // Regenerate single dialog with better animation
        async function regenerateDialog(index) {
            const card = document.querySelectorAll('.dialog-card')[index];
            const dialogText = card.querySelector('.dialog-text');
            const regenerateBtn = card.querySelector('.regenerate-btn');
            const npcTag = card.querySelector('.npc-character-tag');
            const originalText = dialogText.textContent;
            
            // Start animation
            card.classList.add('regenerating');
            regenerateBtn.disabled = true;
            
            // Create loading text animation
            const loadingPhrases = [
                "Generating new dialogue...",
                "Creating unique response...",
                "Thinking of something new..."
            ];
            let phraseIndex = 0;
            
            const textInterval = setInterval(() => {
                dialogText.innerHTML = `<span class="loading-text">${loadingPhrases[phraseIndex % loadingPhrases.length]}</span>`;
                phraseIndex++;
            }, 1000);
            
            try {
                const res = await fetch('/generate-single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: promptInput.value,
                        npcCharacter: npcCharacterInput.value.trim(),
                        style: selectedStyle
                    })
                });
                
                const data = await res.json();
                
                if (data.dialog) {
                    clearInterval(textInterval);
                    // Update the global array with new dialog
                    if (window.generatedDialogs && window.generatedDialogs[index]) {
                        window.generatedDialogs[index] = data.dialog;
                    }
                    // Update current NPC character
                    if (data.npcCharacter) {
                        window.currentNpcCharacter = data.npcCharacter;
                    }
                    // Update NPC tag if present
                    if (npcTag && data.npcCharacter) {
                        npcTag.textContent = data.npcCharacter;
                    }
                    // Update the convert dialog button's data
                    const convertBtn = card.querySelector('.convert-dialog-btn');
                    if (convertBtn) {
                        convertBtn.setAttribute('data-dialog-text', data.dialog);
                        convertBtn.setAttribute('data-npc-character', data.npcCharacter || '');
                    }
                    // Fade in new text
                    dialogText.style.opacity = '0';
                    setTimeout(() => {
                        dialogText.textContent = data.dialog;
                        dialogText.style.opacity = '1';
                    }, 300);
                    showToast('Dialog regenerated!');
                } else {
                    throw new Error('No dialog returned');
                }
            } catch (err) {
                clearInterval(textInterval);
                dialogText.style.opacity = '0';
                setTimeout(() => {
                    dialogText.textContent = originalText;
                    dialogText.style.opacity = '1';
                }, 300);
                showToast('Regeneration failed!', 'error');
            }
            
            // Stop animation
            setTimeout(() => {
                card.classList.remove('regenerating');
                regenerateBtn.disabled = false;
            }, 500);
        }

        function startDialogMode(initialDialog, npcCharacter) {
            document.getElementById('dialogModal').classList.add('show');
            document.getElementById('dialogHistory').innerHTML = '';
            currentScene = promptInput.value; // Mevcut sahneyi sakla
            
            // Start dialog session
            fetch('/start-dialog', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initialDialog: initialDialog,
                    scene: currentScene,
                    npc1: npcCharacter || 'NPC',
                    style: selectedStyle
                })
            })
            .then(res => res.json())
            .then(data => {
                currentDialogId = data.dialogId;
                dialogHistory = data.history;
                renderDialogHistory();
            })
            .catch(err => {
                showToast('Failed to start dialog mode!', 'error');
                console.error(err);
            });
        }

        function closeDialogMode() {
            document.getElementById('dialogModal').classList.remove('show');
            currentDialogId = null;
            dialogHistory = [];
            dialogImages = [];
            updateImageCountBadge();
            // Reset to conversation tab
            document.querySelectorAll('.dialog-tab')[0].click();
        }

        function renderDialogHistory() {
            const historyDiv = document.getElementById('dialogHistory');
            historyDiv.innerHTML = dialogHistory.map((turn, index) => `
                <div class="dialog-message" style="animation-delay: ${index * 0.1}s">
                    <div class="dialog-character">${turn.character}</div>
                    <div class="dialog-text-content">${turn.text}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        document.getElementById('dialogForm').onsubmit = async (e) => {
            e.preventDefault();
            
            if (!currentDialogId) {
                showToast('Dialog session not active!', 'error');
                return;
            }
            
            const npcInput = document.getElementById('dialogNpcInput');
            const emotionSelect = document.getElementById('dialogEmotionSelect');
            const sceneUpdateInput = document.getElementById('dialogSceneUpdate');
            const generateBtn = e.target.querySelector('.dialog-generate-btn');
            
            if (!npcInput.value.trim()) {
                showToast('Please enter NPC character!', 'error');
                return;
            }
            
            // Sahne g√ºncellemesi varsa current scene'i g√ºncelle
            if (sceneUpdateInput.value.trim()) {
                currentScene = sceneUpdateInput.value.trim();
                
                // Sahne g√ºncelleme bilgisini history'ye ekle
                const sceneUpdateMsg = {
                    character: 'üìç Scene Update',
                    text: currentScene
                };
                dialogHistory.push(sceneUpdateMsg);
                renderDialogHistory();
            }
            
            // Disable form
            generateBtn.disabled = true;
            npcInput.disabled = true;
            
            // Add loading message
            const historyDiv = document.getElementById('dialogHistory');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'dialog-loading';
            loadingDiv.innerHTML = `
                <div class="dialog-loading-spinner"></div>
                <div class="dialog-loading-text">Generating response...</div>
            `;
            historyDiv.appendChild(loadingDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;
            
            try {
                const res = await fetch('/continue-dialog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dialogId: currentDialogId,
                        npcCharacter: npcInput.value.trim(),
                        emotion: emotionSelect.value,
                        includeActions: document.getElementById('includeActions').checked,
                        includeNames: document.getElementById('includeNames').checked,
                        sceneUpdate: sceneUpdateInput.value.trim() || null // Yeni parametre
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update history
                dialogHistory = data.history;
                renderDialogHistory();
                
                // Clear inputs
                npcInput.value = '';
                emotionSelect.value = '';
                sceneUpdateInput.value = '';
                sceneUpdateInput.style.display = 'none';
                document.querySelector('.scene-toggle-btn .toggle-icon').textContent = '‚ûï';
                
                showToast('Response generated!');
                
            } catch (err) {
                showToast('Failed to generate response!', 'error');
                console.error(err);
                if (loadingDiv.parentNode) {
                    loadingDiv.remove();
                }
            }
            
            // Re-enable form
            generateBtn.disabled = false;
            npcInput.disabled = false;
            npcInput.focus();
        };

        // Dialog Tab System Functions
        
        // Switch between dialog tabs
        function switchDialogTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.dialog-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab contents
            document.querySelectorAll('.dialog-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'conversation') {
                document.getElementById('conversationTab').classList.add('active');
                document.getElementById('exportImagesBtn').style.display = 'none';
            } else if (tabName === 'images') {
                document.getElementById('imagesTab').classList.add('active');
                document.getElementById('exportImagesBtn').style.display = dialogImages.length > 0 ? 'inline-block' : 'none';
            }
        }

        // Generate image for dialog mode
        async function generateDialogImage() {
            // Get the current scene - either the original or updated one
            const sceneText = currentScene || promptInput.value;
            
            if (!sceneText.trim()) {
                showToast('No scene description available!', 'error');
                return;
            }

            const generateBtn = document.querySelector('.dialog-generate-image-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span> Creating...';

            try {
                const res = await fetch('/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: sceneText })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Add to images array
                const imageData = {
                    id: Date.now(),
                    url: data.image_url,
                    scene: sceneText,
                    timestamp: new Date().toLocaleString(),
                    dialogContext: dialogHistory.slice(-3) // Last 3 dialog entries for context
                };
                
                dialogImages.push(imageData);
                updateDialogImagesList();
                updateImageCountBadge();
                
                showToast('Image created and saved to Images tab!');
                
                // Auto-switch to images tab
                const imagesTabBtn = document.querySelector('.dialog-tab:nth-child(2)');
                imagesTabBtn.click();
                
            } catch (err) {
                showToast('Image creation failed!', 'error');
                console.error('Error:', err);
            }
            
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<span class="btn-text">Create Scene Image</span><span class="btn-icon">üé®</span>';
        }

        // Update images list display
        function updateDialogImagesList() {
            const listContainer = document.getElementById('dialogImagesList');
            
            if (dialogImages.length === 0) {
                listContainer.innerHTML = '<p class="no-images-message">No images generated yet</p>';
                return;
            }
            
            listContainer.innerHTML = dialogImages.map((img, index) => `
                <div class="dialog-image-item" data-image-id="${img.id}">
                    <div class="image-header">
                        <span class="image-number">Image ${index + 1}</span>
                        <span class="image-timestamp">${img.timestamp}</span>
                        <button class="remove-image-btn" onclick="removeDialogImage(${img.id})">√ó</button>
                    </div>
                    <div class="image-content">
                        <img src="${img.url}" alt="Generated scene" onclick="openImageFullscreen('${img.url}')">
                        <div class="image-details">
                            <div class="scene-description">
                                <strong>Scene:</strong> ${img.scene}
                            </div>
                            ${img.dialogContext.length > 0 ? `
                                <div class="dialog-context">
                                    <strong>Context:</strong>
                                    ${img.dialogContext.map(turn => `<div>${turn.character}: ${turn.text.substring(0, 50)}...</div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update image count badge
        function updateImageCountBadge() {
            const badge = document.getElementById('imageCountBadge');
            if (dialogImages.length > 0) {
                badge.textContent = dialogImages.length;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Remove image from list
        function removeDialogImage(imageId) {
            dialogImages = dialogImages.filter(img => img.id !== imageId);
            updateDialogImagesList();
            updateImageCountBadge();
            
            if (dialogImages.length === 0) {
                document.getElementById('exportImagesBtn').style.display = 'none';
            }
        }

        // Open image in fullscreen
        function openImageFullscreen(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'image-fullscreen-modal';
            modal.innerHTML = `
                <div class="fullscreen-content">
                    <button class="fullscreen-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    <img src="${imageUrl}" alt="Fullscreen image">
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // Export dialog images data
        function exportDialogImages() {
            const exportData = {
                sessionId: currentDialogId,
                exportDate: new Date().toISOString(),
                totalImages: dialogImages.length,
                images: dialogImages
            };
            
            const jsonStr = JSON.stringify(exportData, null, 2);
            downloadFile(jsonStr, 'dialog-images-data.json', 'application/json');
            showToast('Images data exported!');
        }

        // Export dialog
        function exportDialog(format) {
            if (!currentDialogId) {
                showToast('No active dialog to export!', 'error');
                return;
            }
            
            fetch('/export-dialog', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dialogId: currentDialogId,
                    format: format
                })
            })
            .then(res => res.json())
            .then(data => {
                if (format === 'json') {
                    const jsonStr = JSON.stringify(data, null, 2);
                    downloadFile(jsonStr, 'dialog-conversation.json', 'application/json');
                } else {
                    downloadFile(data.text, 'dialog-conversation.txt', 'text/plain');
                }
                showToast(`Dialog exported as ${format.toUpperCase()}!`);
            })
            .catch(err => {
                showToast('Export failed!', 'error');
                console.error(err);
            });
        }

        // Favorite dialogs
        let favoriteDialogs = JSON.parse(localStorage.getItem('favorites') || '[]');

        function toggleFavorite(dialogText, button) {
            const index = favoriteDialogs.findIndex(fav => fav.text === dialogText);
            
            if (index === -1) {
                favoriteDialogs.push({
                    text: dialogText,
                    scene: promptInput.value,
                    npcCharacter: npcCharacterInput.value.trim(),
                    style: selectedStyle,
                    timestamp: new Date().toISOString()
                });
                button.classList.add('favorited');
                button.innerHTML = '‚≠ê';
                showToast('Added to favorites!');
            } else {
                favoriteDialogs.splice(index, 1);
                button.classList.remove('favorited');
                button.innerHTML = '‚òÜ';
                showToast('Removed from favorites!');
            }
            
            localStorage.setItem('favorites', JSON.stringify(favoriteDialogs));
        }

        // Save scene
        function saveScene() {
            const scene = {
                description: promptInput.value,
                npcCharacter: npcCharacterInput.value.trim(),
                style: selectedStyle,
                dialogs: Array.from(document.querySelectorAll('.dialog-text')).map(el => el.textContent),
                imageUrl: document.getElementById('generatedImage').src || '',
                timestamp: new Date().toISOString()
            };
            
            const savedScenes = JSON.parse(localStorage.getItem('savedScenes') || '[]');
            savedScenes.unshift(scene);
            if (savedScenes.length > 20) savedScenes.pop();
            localStorage.setItem('savedScenes', JSON.stringify(savedScenes));
            
            showToast('Scene saved!');
            updateSavedScenesList();
        }

        // Toggle saved scenes sidebar
        function toggleSavedScenes() {
            const sidebar = document.getElementById('savedScenes');
            sidebar.classList.toggle('open');
            updateSavedScenesList();
        }

        // Update saved scenes list
        function updateSavedScenesList() {
            const savedScenes = JSON.parse(localStorage.getItem('savedScenes') || '[]');
            const listDiv = document.getElementById('savedScenesList');
            
            if (savedScenes.length === 0) {
                listDiv.innerHTML = '<p class="no-saves">No saved scenes yet</p>';
                return;
            }
            
            listDiv.innerHTML = savedScenes.map((scene, index) => `
                <div class="scene-card" onclick="loadScene(${index})">
                    <h4>${scene.description.substring(0, 50)}...</h4>
                    <p class="scene-meta">
                        <span>üé≠ ${scene.style}</span>
                        <span>üë§ ${scene.npcCharacter || 'Various'}</span>
                        <span>üí¨ ${scene.dialogs.length} dialogs</span>
                    </p>
                    <p class="scene-date">${new Date(scene.timestamp).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        // Load saved scene
        function loadScene(index) {
            const savedScenes = JSON.parse(localStorage.getItem('savedScenes') || '[]');
            const scene = savedScenes[index];
            
            if (scene) {
                promptInput.value = scene.description;
                charCount.textContent = scene.description.length;
                
                npcCharacterInput.value = scene.npcCharacter || '';
                npcCharCount.textContent = (scene.npcCharacter || '').length;
                
                document.querySelectorAll('.style-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.style === scene.style) {
                        btn.classList.add('active');
                        selectedStyle = scene.style;
                    }
                });
                
                resultsSection.style.display = 'block';
                
                const npcTag = scene.npcCharacter ? 
                    `<span class="npc-character-tag">${scene.npcCharacter}</span>` : '';
                
                responsesDiv.innerHTML = scene.dialogs.map((dialog, i) => `
                    <div class="dialog-card" style="animation-delay: ${i * 0.1}s">
                        <button class="favorite-btn" onclick="toggleFavorite('${dialog.replace(/'/g, "\\'")}', this)">
                            ‚òÜ
                        </button>
                        <div class="dialog-header">
                            <div class="npc-info">
                                <span class="npc-name">Dialogue ${i + 1}</span>
                                ${npcTag}
                            </div>
                            <button class="copy-btn" onclick="copyDialog('${dialog.replace(/'/g, "\\'")}', this)">
                                üìã
                            </button>
                        </div>
                        <p class="dialog-text">${dialog}</p>
                        <div class="dialog-footer">
                            <button class="convert-dialog-btn" onclick="startDialogMode('${dialog.replace(/'/g, "\\'")}', '${scene.npcCharacter || ''}')">
                                <span class="icon">üí¨</span>
                                <span>Convert to Dialog</span>
                            </button>
                            <button class="regenerate-btn" onclick="regenerateDialog(${i})">
                                <span class="regenerate-icon">üîÑ</span>
                                <span class="regenerate-text">Regenerate</span>
                            </button>
                        </div>
                    </div>
                `).join("");
                
                if (scene.imageUrl) {
                    imageSection.style.display = 'block';
                    document.getElementById('generatedImage').src = scene.imageUrl;
                    document.getElementById('generatedImage').style.display = 'block';
                }
                
                toggleSavedScenes();
                showToast('Scene loaded!');
            }
        }

        // Scene templates
        const sceneTemplates = [
            {
                name: "üè∞ Medieval Town",
                description: "A bustling medieval marketplace where merchants hawk their wares and guards patrol the cobblestone streets",
                npc: "merchant"
            },
            {
                name: "üèïÔ∏è Campfire",
                description: "Adventurers gathered around a campfire at night, sharing stories of their travels and battles",
                npc: "veteran adventurer"
            },
            {
                name: "üèöÔ∏è After Battle",
                description: "Villagers emerging from hiding after a fierce battle, checking on neighbors and surveying damage",
                npc: "worried mother"
            },
            {
                name: "üé™ Festival",
                description: "Annual harvest festival with music, dancing, and celebration throughout the village",
                npc: "excited child"
            },
            {
                name: "‚ò†Ô∏è Dungeon",
                description: "Dark dungeon where prisoners await their fate, guards patrol, and mysterious sounds echo",
                npc: "prison guard"
            },
            {
                name: "üåä Seaside Port",
                description: "Busy port town with sailors, merchants, and travelers from distant lands",
                npc: "old fisherman"
            },
            {
                name: "üå≤ Forest Camp",
                description: "Bandits hiding in the forest, planning their next ambush on merchant caravans",
                npc: "bandit leader"
            },
            {
                name: "üèõÔ∏è Temple",
                description: "Sacred temple where pilgrims seek blessings and priests perform ancient rituals",
                npc: "temple priest"
            },
            {
                name: "üöÄ Space Station",
                description: "Futuristic space station where crew members deal with technical malfunctions and alien visitors",
                npc: "station engineer"
            },
            {
                name: "üèôÔ∏è Cyberpunk City",
                description: "Neon-lit streets where hackers, corporate agents, and street vendors navigate the digital underground",
                npc: "street vendor"
            }
        ];

        // Show templates modal
        function showTemplates() {
            const modal = document.getElementById('templatesModal');
            const list = document.getElementById('templatesList');
            
            list.innerHTML = sceneTemplates.map(template => `
                <div class="template-card" onclick="useTemplate('${template.description}', '${template.npc}')">
                    <h3>${template.name}</h3>
                    <p>${template.description}</p>
                    <p style="color: var(--npc-accent); font-size: 0.85rem; margin-top: 8px;">
                        <strong>Suggested NPC:</strong> ${template.npc}
                    </p>
                </div>
            `).join('');
            
            modal.classList.add('show');
        }

        // Close templates modal
        function closeTemplates() {
            document.getElementById('templatesModal').classList.remove('show');
        }

        // Use template
        function useTemplate(description, npc) {
            promptInput.value = description;
            charCount.textContent = description.length;
            npcCharacterInput.value = npc;
            npcCharCount.textContent = npc.length;
            closeTemplates();
            showToast('Template loaded!');
        }

        // Initialize
        updateSavedScenesList();

        // Close dialog modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('dialogModal').classList.contains('show')) {
                closeDialogMode();
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target.closest('.convert-dialog-btn')) {
                const btn = e.target.closest('.convert-dialog-btn');
                const index = parseInt(btn.dataset.dialogIndex);
                
                if (window.generatedDialogs && window.generatedDialogs[index]) {
                    const dialogText = window.generatedDialogs[index];
                    const npcCharacter = window.currentNpcCharacter;
                    startDialogMode(dialogText, npcCharacter);
                }
            }
        });
    </script>
</body>
</html>
